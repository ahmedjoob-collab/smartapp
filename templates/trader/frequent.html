{% extends "base.html" %}
{% block title %}المترددين{% endblock %}

{% block content %}
<div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3">
  <h1 class="h5 mb-0">المترددين</h1>
  <div class="d-flex gap-2">
    <a class="btn btn-light" href="{{ url_for('trader_services_bp.index') }}"><i class="fas fa-briefcase"></i> خدمات التجار</a>
    {% if is_admin %}
    <a class="btn btn-outline-primary" href="{{ url_for('trader_services_bp.frequent_import_view') }}"><i class="fas fa-upload"></i> استيراد</a>
    {% endif %}
  </div>
  <div class="w-100"></div>
  <ul class="nav nav-pills mt-2">
    <li class="nav-item"><a class="nav-link active" href="{{ url_for('trader_services_bp.frequent_visitors', tab='recent') }}">بيانات حديثة</a></li>
  </ul>
  <div id="recentCountBox" class="mt-2 d-none">
    <span class="badge bg-secondary">
      <i class="fas fa-list-ol"></i>
      عدد السجلات: <span id="recentCountTotal">—</span>
    </span>
  </div>
 </div>

<form class="row gy-2 gx-2 align-items-end mb-3" method="get" action="{{ url_for('trader_services_bp.frequent_visitors') }}">
  <input type="hidden" name="tab" value="recent" />
  <div class="col-sm-6 col-lg-5">
    <label class="form-label">بحث شامل</label>
    <input type="text" name="q" value="{{ q or '' }}" class="form-control" placeholder="اكتب جزء من أي قيمة">
  </div>

{# تم إزالة دعم البيانات القديمة: لا حاجة لاختيار فترة #}

  <div class="col-sm-6 col-lg-3">
    <label class="form-label">البحث في عمود</label>
    <select id="searchInSelect" name="search_in" class="form-select">
      <option value="all" {{ 'selected' if search_in=='all' }}>الكل (كل الأعمدة)</option>
      {# فلتر دفاعي داخل القالب لضمان عدم ظهور الأعمدة المستبعدة حتى لو وصلت من السيرفر بالخطأ #}
      {% set excluded = fault_types + ['الحوالة المطلوبة','ملاحظات','ملاحظات1'] %}
      {% set excluded_norm = excluded|map('lower')|map('replace',' ','')|list %}
      {% for c in search_cols %}
        {% set c_norm = c|lower|trim|replace(' ','') %}
        {% if c_norm not in excluded_norm %}
          <option value="{{ c }}" {{ 'selected' if search_in==c }}>{{ c }}</option>
        {% endif %}
      {% endfor %}
    </select>
  </div>

  <div class="col-sm-6 col-lg-2">
    <label class="form-label">عدد السجلات</label>
    <select name="page_size" class="form-select">
      {% for n in [10,25,50,100,200,500] %}<option value="{{n}}" {{ 'selected' if page_size==n }}>{{n}}</option>{% endfor %}
    </select>
  </div>

  <div class="col-sm-12 col-lg-2 text-end">
    <button class="btn btn-primary w-100" type="submit"><i class="fas fa-search"></i> تطبيق</button>
  </div>
</form>

{% if not cols or cols|length == 0 %}
  <div class="alert alert-info">لا توجد بيانات لعرضها.</div>
{% else %}
  <div class="data-table-wrap">
    {% if tab=='recent' and (('النوع' not in cols) or (('مكتب' not in cols) and ('المكتب' not in cols)) or (('الاذن' not in cols) and ('رقم الإذن' not in cols) and ('رقم الاذن' not in cols))) %}
    <div class="alert alert-warning mb-2" role="alert">
      ملاحظة: تأكد من توفر أعمدة النوع/المكتب/رقم الإذن. سيتم عرضها إن وُجدت بأي مسمى بديل.
    </div>
    {% endif %}
    <div class="table-responsive">
      <table class="table table-sm table-striped table-hover table-bordered data-table">
        <thead>
          <tr>
            {% for c in cols %}<th>{{ c }}</th>{% endfor %}
            {% if tab=='recent' %}<th>إجراءات</th>{% endif %}
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
            <tr>
              {% for c in cols %}<td>{{ r.get(c,'') }}</td>{% endfor %}
              {% if tab=='recent' %}
                <td class="text-nowrap">
                  {% set owner = r.get('خدمات','') %}
                  {% if is_admin or owner==current_user.username %}
                    <button type="button" class="btn btn-sm btn-outline-secondary" 
                            data-action="edit" 
                            data-index="{{ r.get('__index','') }}"
                            data-serial="{{ r.get('مسلسل','') }}" 
                            data-order="{{ r.get('الاذن', r.get('رقم الإذن', r.get('رقم الاذن',''))) }}" 
                            data-date="{{ r.get('التاريخ','') }}"
                            data-client-number="{{ r.get('رقم العميل','') }}"
                            data-client-name="{{ r.get('اسم العميل','') }}"
                            data-dept="{{ r.get('الادارة','') }}"
                            data-office="{{ r.get('مكتب', r.get('المكتب','')) }}"
                            data-services="{{ r.get('خدمات','') }}"
                            data-maintenance="{{ r.get('صيانه','') }}"
                            data-transfer="{{ r.get('الحوالة المطلوبة','') }}"
                            data-notes="{{ r.get('ملاحظات','') }}"
                            data-row='{{ r|tojson }}'>
                      تعديل
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger ms-1" 
                            data-action="delete" 
                            data-index="{{ r.get('__index','') }}"
                            data-serial="{{ r.get('مسلسل','') }}" 
                            data-order="{{ r.get('الاذن', r.get('رقم الإذن', r.get('رقم الاذن',''))) }}" 
                            data-date="{{ r.get('التاريخ','') }}">
                      حذف
                    </button>
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>
              {% endif %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="d-flex justify-content-end mt-2">
    <a class="btn btn-success" href="{{ url_for('trader_services_bp.frequent_export', tab=tab, q=q, search_in=search_in, label=current_label) }}"><i class="fas fa-file-export"></i> تصدير Excel</a>
  </div>

  <nav class="mt-3" aria-label="الصفحات">
    <ul class="pagination justify-content-center">
      <li class="page-item {% if not pagination.prev %}disabled{% endif %}">
        <a class="page-link" href="{{ pagination.prev or '#' }}">السابق</a>
      </li>
      {% for p in pagination.first_pages %}
      <li class="page-item {% if p.active %}active{% endif %}"><a class="page-link" href="{{ p.url }}">{{ p.n }}</a></li>
      {% endfor %}
      {% if pagination.show_ellipsis %}<li class="page-item disabled"><span class="page-link">…</span></li>{% endif %}
      {% if pagination.last %}
        <li class="page-item {% if pagination.last.active %}active{% endif %}"><a class="page-link" href="{{ pagination.last.url }}">{{ pagination.last.n }}</a></li>
      {% endif %}
      <li class="page-item {% if not pagination.next %}disabled{% endif %}">
        <a class="page-link" href="{{ pagination.next or '#' }}">التالي</a>
      </li>
    </ul>
    <p class="text-center text-muted small mb-0">صفحة {{ pagination.page }} من {{ pagination.total_pages }}</p>
  </nav>
{% endif %}

{% if tab=='recent' %}
<!-- Modal: تعديل سجل حديث -->
<div class="modal fade" id="editRecentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-edit"></i> تعديل المتردد (حديث)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editRecentForm">
          <!-- بيانات أساسية (مخفية) للحفاظ على السياق -->
          <div class="row g-2 d-none">
            <div class="col-md-3"><label class="form-label">المسلسل</label><input class="form-control" name="serial" readonly></div>
            <div class="col-md-3"><label class="form-label">التاريخ</label><input class="form-control" name="date" readonly></div>
            <div class="col-md-3"><label class="form-label">رقم العميل</label><input class="form-control" name="client_number" readonly></div>
            <div class="col-md-6"><label class="form-label">اسم العميل</label><input class="form-control" name="client_name" readonly></div>
            <div class="col-md-3"><label class="form-label">الادارة</label><input class="form-control" name="الادارة" readonly></div>
            <div class="col-md-3"><label class="form-label">مكتب</label><input class="form-control" name="مكتب" readonly></div>
            <div class="col-md-4"><label class="form-label">خدمات</label><input class="form-control" name="خدمات" readonly></div>
            <input type="hidden" name="row_index" value="">
          </div>

          <!-- تفاصيل التعديل -->
          <div class="row g-2">
            <div class="col-12">
              <h6 class="border-bottom pb-1 mb-2 text-primary">تفاصيل التعديل</h6>
            </div>
            <div class="col-md-4">
              <label class="form-label">رقم الإذن</label>
              <input class="form-control" name="order_number" placeholder="أرقام فقط">
            </div>
            <div class="col-md-4">
              <label class="form-label">صيانه</label>
              <select class="form-select" name="صيانه" id="maintenanceSelect">
                <option value="">—</option>
                {% for n in maintenance_names %}<option value="{{n}}">{{n}}</option>{% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">الحوالة المطلوبة</label>
              <input class="form-control" name="الحوالة المطلوبة">
            </div>
            <div class="col-12">
              <label class="form-label">ملاحظات</label>
              <textarea class="form-control" rows="2" name="ملاحظات" placeholder="اكتب ملاحظات مختصرة وواضحة"></textarea>
            </div>
          </div>

          <!-- الأعطال -->
          <div class="row g-2 mt-3">
            <div class="col-12">
              <div class="border rounded p-2 bg-light">
                <div class="d-flex align-items-center justify-content-between mb-1">
                  <div class="form-label mb-0">أنواع الأعطال</div>
                  <small class="text-muted">حدّد الأعطال المرتبطة بالسجل</small>
                </div>
                <div class="row g-2">
                  {% for ft in fault_types %}
                    {% set ft_id = ft|replace(' ','_') %}
                    <div class="col-auto">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="fault_{{ft_id}}" id="fault_{{ft_id}}">
                        <label class="form-check-label" for="fault_{{ft_id}}">{{ft}}</label>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
        <button type="button" class="btn btn-primary" id="saveRecentBtn">حفظ</button>
      </div>
    </div>
  </div>
 </div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if tab=='recent' %}
<script>
(function(){
  const modalEl = document.getElementById('editRecentModal');
  const formEl = document.getElementById('editRecentForm');
  const saveBtn = document.getElementById('saveRecentBtn');
  let modal; try{ modal = new bootstrap.Modal(modalEl);}catch(e){}

  function openEdit(row){
    // تعبئة الحقول
    formEl.serial.value = row['مسلسل']||'';
    formEl.order_number.value = row['الاذن']||'';
    formEl.date.value = row['التاريخ']||'';
    formEl.client_number.value = row['رقم العميل']||'';
    formEl.client_name.value = row['اسم العميل']||'';
    formEl['الادارة'].value = row['الادارة']||'';
    formEl['مكتب'].value = row['مكتب']||'';
    formEl['خدمات'].value = row['خدمات']||'';
    formEl['صيانه'].value = row['صيانه']||'';
    formEl['الحوالة المطلوبة'].value = row['الحوالة المطلوبة']||'';
    formEl['ملاحظات'].value = row['ملاحظات']||'';
    formEl.row_index.value = (row['__index']||'');
    // الأعطال
    {% for ft in fault_types %}
      const ck_{{ft|replace(' ','_')}} = document.getElementById('fault_{{ft|replace(' ','_')}}');
      if(ck_{{ft|replace(' ','_')}}) ck_{{ft|replace(' ','_')}}.checked = (String(row['{{ft}}']||'').trim() === '1');
    {% endfor %}
    if(modal) modal.show();
  }

  function collectUpdates(){
    const updates = {};
    // مسموح فقط: الأعطال، صيانة، رقم الإذن، ملاحظات، الحوالة المطلوبة
    updates['الاذن'] = formEl.order_number.value||'';
    updates['صيانه'] = formEl['صيانه'].value||'';
    updates['الحوالة المطلوبة'] = formEl['الحوالة المطلوبة'].value||'';
    updates['ملاحظات'] = formEl['ملاحظات'].value||'';
    {% for ft in fault_types %}
      updates['{{ft}}'] = document.getElementById('fault_{{ft|replace(' ','_')}}').checked ? '1' : '';
    {% endfor %}
    return updates;
  }

  // أحداث الأزرار في الجدول
  document.querySelectorAll('[data-action="edit"]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      let rowData = {};
      try { rowData = JSON.parse(btn.getAttribute('data-row')||'{}'); } catch(e) { rowData = {}; }
      // تأكد من وجود الأعمدة الضرورية إذا كانت غير موجودة
      if(!rowData['الاذن']){ rowData['الاذن'] = btn.getAttribute('data-order')||''; }
      rowData['__index'] = btn.getAttribute('data-index')||'';
      openEdit(rowData);
    });
  });
  document.querySelectorAll('[data-action="delete"]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      if(!confirm('هل تريد حذف هذا السجل؟')) return;
      const payload = { row_index: btn.getAttribute('data-index')||'' };
      const res = await fetch('{{ url_for('trader_services_bp.frequent_delete_recent_row') }}', {
        method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
      });
      const data = await res.json();
      alert(data.message||'');
      if(data.success){ location.reload(); }
    });
  });

  // حفظ التعديل
  if(saveBtn){ saveBtn.addEventListener('click', async ()=>{
    const payload = {
      serial: formEl.serial.value||'',
      order_number: formEl.order_number.value||'',
      date: formEl.date.value||'',
      row_index: formEl.row_index.value||'',
      updates: collectUpdates()
    };
    const res = await fetch('{{ url_for('trader_services_bp.frequent_update_recent') }}', {
      method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
    });
    const data = await res.json();
    alert(data.message||'');
    if(data.success){ location.reload(); }
  });}

  // جلب عداد السجلات الحديثة وعرضه
  async function fetchRecentCount(){
    try{
      const res = await fetch('{{ url_for('trader_services_bp.frequent_recent_count') }}');
      const data = await res.json();
      if(data && data.success){
        const box = document.getElementById('recentCountBox');
        const totalEl = document.getElementById('recentCountTotal');
        if(totalEl){ totalEl.textContent = String(data.total||0); }
        if(box){ box.classList.remove('d-none'); }
      }
    }catch(e){ /* تجاهل الأخطاء الصامتة */ }
  }
  fetchRecentCount();
})();
</script>
{% endif %}
{% endblock %}