{% extends "base.html" %}
{% block title %}{{ title or ('ุฅุถุงูุฉ - ุงูุฏุนู ุงูููู' if mode=='create' else 'ุชุนุฏูู - ุงูุฏุนู ุงูููู') }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
    <h1 class="h4 mb-0 text-primary">{{ title or ('ุฅุถุงูุฉ ุณุฌู - ุงูุฏุนู ุงูููู' if mode=='create' else 'ุชุนุฏูู ุณุฌู - ุงูุฏุนู ุงูููู') }}</h1>
    <div class="d-flex gap-2">
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('support_bp.index') }}">
            <i class="fas fa-list me-2"></i>ุฑุฌูุน ูููุงุฆูุฉ
        </a>
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('main_bp.dashboard') }}">
            <i class="fas fa-home me-2"></i>ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ
        </a>
    </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="mb-4">
            {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'danger' or category == 'warning' else 'success' }} py-2 mb-2 small" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>{{ message | safe }}
                </div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

<form method="post" id="mainForm" class="card shadow-lg border-0">
    {% if mode == 'edit' %}
        <input type="hidden" name="record_id" id="record_id" value="{{ rec.id }}">
    {% endif %}
    <input type="hidden" name="force_bank_save" id="h_force_save" value="0">
    
    <div class="card-body p-4">
        
        <h5 class="card-title text-primary mb-3 pb-2 border-bottom"><i class="fas fa-edit me-2"></i>ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ ููุณุฌู</h5>
        <div class="row g-3">
            
            <div class="col-12 col-md-6 col-lg-4">
                <label for="name" class="form-label small fw-bold">ุงุณู ุงููุฎุจุฒ/ุงูุชุงุฌุฑ <span class="text-danger">*</span></label>
                <input type="text" id="name" name="name" class="form-control form-control-sm" required value="{{ rec.name if rec else '' }}">
            </div>

            <div class="col-12 col-md-6 col-lg-4">
                <label for="code" class="form-label small fw-bold">ุงูููุฏ (ุฃุฑูุงูุ ูุณุงูุงุชุ -ุ /) (ุงุฎุชูุงุฑู)</label>
                <input 
                    type="text" 
                    id="code" 
                    name="code" 
                    class="form-control form-control-sm text-start" 
                    pattern="[A-Za-z0-9\s\/\-]*" 
                    title="ูุฌุจ ุฅุฏุฎุงู ุฃุฑูุงู ูุญุฑูู ุฅูุฌููุฒูุฉ ููุณุงูุงุช ูุฑููุฒ / ู -" 
                    value="{{ rec.code if rec else '' }}"
                >
            </div>

            <div class="col-12 col-md-6 col-lg-4">
                <label for="work_type" class="form-label small fw-bold">ุงูุนูู ุงููุญูู <span class="text-danger">*</span></label>
                <select id="work_type" name="work_type" class="form-select form-select-sm" required>
                    <option value="">-- ุงุฎุชุฑ ุงููุทููุจ --</option>
                    <option value="ุฃุนูุงู ุฏุนู ุนุงูุฉ" {% if rec and rec.work_type == 'ุฃุนูุงู ุฏุนู ุนุงูุฉ' %}selected{% endif %}>ุฃุนูุงู ุฏุนู ุนุงูุฉ</option>
                    <option value="ุญุณุงุจุงุช ุจูููุฉ" {% if rec and rec.work_type == 'ุญุณุงุจุงุช ุจูููุฉ' %}selected{% endif %}>ุญุณุงุจุงุช ุจูููุฉ</option>
                </select>
            </div>

            <div class="col-12 col-md-6 col-lg-4" id="div_type_select" style="display:none;">
                <label for="type_select" class="form-label small fw-bold">ุงูููุน</label>
                <select id="type_select" name="type_select" class="form-select form-select-sm">
                    <option value="">-- ุงุฎุชุฑ ุงูููุน --</option>
                </select>
                {% if rec and rec.type_select %}
                    <input type="hidden" id="initial_type_select" value="{{ rec.type_select }}">
                {% endif %}
            </div>
            
        </div>

        <hr class="my-4">
        
        <h5 class="card-title text-primary mb-3 pb-2 border-bottom"><i class="fas fa-file-alt me-2"></i>ุงูุชูุงุตูู ูุงูููุงุญุธุงุช</h5>
        <div class="row g-3">
            
            <div class="col-12 col-md-6">
                <label for="sender_email_name" class="form-label small fw-bold">ุงุณู/ุจุฑูุฏ ูุฑุณู ุงูุจูุงูุงุช</label>
                <input type="text" id="sender_email_name" name="sender_email_name" class="form-control form-control-sm" value="{{ rec.sender_email_name if rec else '' }}">
            </div>
            
            <div class="col-12 col-md-6">
                <label for="postal_id" class="form-label small fw-bold">ุฑูู ุงูุจุฑูุฏ (ุงุฎุชูุงุฑู)</label>
                <input 
                    type="text" 
                    id="postal_id" 
                    name="postal_id" 
                    class="form-control form-control-sm text-start" 
                    pattern="[0-9]*" 
                    onkeypress="return (event.charCode >= 48 && event.charCode <= 57)" 
                    title="ูุฌุจ ุฅุฏุฎุงู ุฃุฑูุงู ููุท" 
                    value="{{ rec.postal_id if rec else '' }}">
            </div>
            
            <div class="col-12" id="work_detail_container">
                <label for="work_detail" class="form-label small fw-bold">ุชูุงุตูู ุงูุนูู ุงููุทููุจ / ุฃุนูุงู ุฏุนู ุนุงูุฉ</label>
                <textarea id="work_detail" name="work_detail" class="form-control form-control-sm" rows="2">{{ rec.work_detail if rec else '' }}</textarea>
            </div>

            <div class="col-12">
                <label for="notes" class="form-label small fw-bold">ููุงุญุธุงุช (ุฏุงุฎูู)</label>
                <textarea id="notes" name="notes" class="form-control form-control-sm" rows="2">{{ rec.notes if rec else '' }}</textarea>
            </div>
        </div>
        
        <hr class="my-4">

        <h5 class="card-title text-primary mb-3 pb-2 border-bottom"><i class="fas fa-university me-2"></i>ุจูุงูุงุช ุงูุญุณุงุจ ุงูุจููู ุงูููุฎุฒูููุฉ</h5>
        
        <div class="row g-3" id="bank_data_display_section">
            
            <div class="col-12 col-md-6 col-lg-4">
                <label class="form-label small">Request Number</label>
                <input type="text" id="bank_request_number" name="bank_request_number" class="form-control form-control-sm bg-light"
                       readonly value="{{ rec.bank_request_number if rec else '' }}" placeholder="- -">
            </div>
            
            <div class="col-12 col-md-6 col-lg-4">
                <label class="form-label small"><span id="display_bakery_code_label">Bakery Code</span></label>
                <input type="text" id="bank_bakery_code" name="bank_bakery_code" class="form-control form-control-sm bg-light"
                       readonly value="{{ rec.bank_bakery_code if rec else '' }}" placeholder="- -">
            </div>
            
            <div class="col-12 col-md-6 col-lg-4">
                <label class="form-label small">BANK_ID</label>
                <input type="text" id="bank_id" name="bank_id" class="form-control form-control-sm bg-light"
                       readonly value="{{ rec.bank_id if rec else '' }}" placeholder="- -">
            </div>
            
            <div class="col-12 col-md-6 col-lg-4">
                <label class="form-label small">BANK_ACC_NUMBER (ูุจุฏุฃ ุจู EG)</label>
                <input type="text" id="bank_acc_number" name="bank_acc_number" class="form-control form-control-sm bg-light"
                       readonly value="{{ rec.bank_acc_number if rec else '' }}" placeholder="- -">
            </div>
            
            <div class="col-12 col-md-6 col-lg-4">
                <label class="form-label small">BANK_ACC_NAME</label>
                <input type="text" id="bank_acc_name" name="bank_acc_name" class="form-control form-control-sm bg-light"
                       readonly value="{{ rec.bank_acc_name if rec else '' }}" placeholder="- -">
            </div>
            
            <div class="col-12 col-md-6 col-lg-4">
                <label class="form-label small">National ID</label>
                <input type="text" id="bank_national_id" name="bank_national_id" class="form-control form-control-sm bg-light"
                       readonly value="{{ rec.bank_national_id if rec else '' }}" placeholder="- -">
            </div>
            
            <input type="hidden" name="bank_data_saved" id="h_bank_saved" value="{{ '1' if rec.bank_request_number else '0' }}">
        </div>
        
        <div class="row g-3 align-items-end mt-2">
            <div class="col-12 col-md-4 d-grid offset-md-8">
                <button type="button" class="btn btn-outline-info btn-sm fw-bold" id="btn_manual_bank_modal" data-bs-toggle="modal" data-bs-target="#bankModal" style="display:none;">
                    <i class="fas fa-edit me-2"></i>ูุชุญ ูุงูุฐุฉ ุจูุงูุงุช ุงูุจูู
                </button>
            </div>
            
            <div class="col-12" id="bank_data_warning" style="display:none;">
                <div class="alert alert-warning py-2 mb-0 small" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i><strong>ุชูุจูู:</strong> ูุฌุจ ุฅุฏุฎุงู ูุญูุธ ุจูุงูุงุช ุงูุญุณุงุจ ุงูุจููู ูู ุงููุงูุฐุฉ ุงูููุจุซูุฉ ุฃููุงู ูุฅูุบุงุก ุชุนุทูู ุฒุฑ ุงูุญูุธ.
                </div>
            </div>
        </div>
        
        <hr class="my-4">

        <h5 class="card-title text-primary mb-3 pb-2 border-bottom"><i class="fas fa-bell me-2"></i>ุฅุนุฏุงุฏุงุช ุงูุชุฐููุฑ (ุงุฎุชูุงุฑู)</h5>
        <div class="row g-3">
            <div class="col-12 col-md-8">
                <label for="reminder_message" class="form-label small fw-bold">ุฑุณุงูุฉ ุงูุชุฐููุฑ</label>
                <input type="text" id="reminder_message" name="reminder_message" class="form-control form-control-sm" value="{{ rec.reminder_message if rec else '' }}">
            </div>

            <div class="col-12 col-md-4">
                <label for="reminder_at_local" class="form-label small fw-bold">ููุนุฏ ุงูุชุฐููุฑ (ุจุงูุชูููุช ุงููุญูู)</label>
                <input type="datetime-local" id="reminder_at_local" name="reminder_at_local" class="form-control form-control-sm" value="{{ rec.reminder_at_local if rec else '' }}">
            </div>
        </div>

    </div> 

    <div class="card-footer d-flex justify-content-end gap-2 bg-light p-3">
        <button type="submit" class="btn btn-success px-4 shadow-sm btn-sm fw-bold" id="btnSave">
            <i class="fas fa-save me-2"></i>ุญูุธ ุงูุณุฌู
        </button>
    </div>
</form>

<div class="modal fade" id="bankModal" tabindex="-1" aria-labelledby="bankModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-info shadow-lg">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="bankModalLabel"><i class="fas fa-money-check-alt me-2"></i>ุฅุฏุฎุงู ุจูุงูุงุช ุงูุญุณุงุจ ุงูุจููู</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body row g-3 p-4">
                    <p class="text-muted small border-bottom pb-2">
                        ูุฑุฌู ุฅุฏุฎุงู ุงูุจูุงูุงุช ุงููุทููุจุฉ ุจุนูุงูุฉ. ุญููู ุงูุฃุฑูุงู ูุง ุชูุจู ุงูุญุฑูู.
                        <br>
                        <span class="fw-bold text-danger">ุชูุจูู:</span> ุญูู **National ID** ูุฌุจ ุฃู ูููู **14 ุฑูููุง** ุจุงูุถุจุท. ุญูู **BANK\_ID** ููุจู **ุญุฑูู ุฅูุฌููุฒูุฉ ูุจูุฑุฉ ููุท**.
                        <br>
                        <span class="fw-bold text-dark">ุฌููุน ุงูุญููู ููุง ุฅูุฒุงููุฉ ุฅุฐุง ุชู ูุชุญ ุงููุงูุฐุฉ.</span>
                    </p>
                
                <div class="col-12 col-md-6">
                    <label for="m_req" class="form-label small">Request Number <span class="text-danger">*</span></label>
                    <input 
                        type="text" 
                        id="m_req" 
                        class="form-control form-control-sm text-start" 
                        pattern="[0-9]*" 
                        onkeypress="return (event.charCode >= 48 && event.charCode <= 57)"
                        title="ุฃุฑูุงู ููุท" 
                        value="{{ rec.bank_request_number if rec else '' }}" 
                        placeholder="ุฃุฑูุงู ููุท" 
                        required>
                </div>
                
                <div class="col-12 col-md-6">
                    <label for="m_bak" class="form-label small"><span id="bakery_code_label">Bakery_Code</span> <span class="text-danger">*</span></label>
                    <input 
                        type="text" 
                        id="m_bak" 
                        class="form-control form-control-sm text-start" 
                        pattern="[0-9]*" 
                        onkeypress="return (event.charCode >= 48 && event.charCode <= 57)"
                        title="ุฃุฑูุงู ููุท" 
                        value="{{ rec.bank_bakery_code if rec else '' }}" 
                        placeholder="ุฃุฑูุงู ููุท" 
                        required>
                </div>
                
                <div class="col-12 col-md-6">
                    <label for="m_id" class="form-label small">BANK_ID <span class="text-danger">*</span></label>
                    <input 
                        type="text" 
                        id="m_id" 
                        class="form-control form-control-sm text-start" 
                        pattern="[A-Z]*" 
                        oninput="this.value = this.value.toUpperCase()" 
                        title="ุญุฑูู ุฅูุฌููุฒูุฉ ูุจูุฑุฉ ููุท" 
                        value="{{ rec.bank_id if rec else '' }}" 
                        required>
                </div>
                
                <div class="col-12 col-md-6">
                    <label for="m_acc" class="form-label small">BANK_ACC_NUMBER (ูุง ุจุนุฏ EG) <span class="text-danger">*</span></label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-light text-primary fw-bold" id="eg-prefix">EG</span>
                        <input 
                            type="text" 
                            id="m_acc" 
                            class="form-control text-start" 
                            pattern="[0-9]*" 
                            onkeypress="return (event.charCode >= 48 && event.charCode <= 57)"
                            title="ุฃุฑูุงู ููุท ุจุนุฏ EG" 
                            value="{{ rec.bank_acc_number[2:] if rec and rec.bank_acc_number and rec.bank_acc_number.upper().startswith('EG') else '' }}" 
                            placeholder="ุฃุฑูุงู ููุท" 
                            required>
                    </div>
                    <small class="text-muted small">ุฃุฏุฎู ุงูุฃุฑูุงู ููุทุ ุณูุชู ุฅุถุงูุฉ EG ุชููุงุฆูุงู ูู ุงูุจุฏุงูุฉ.</small>
                </div>
                
                <div class="col-12">
                    <label for="m_name" class="form-label small">BANK_ACC_NAME <span class="text-danger">*</span></label>
                    <input type="text" id="m_name" class="form-control form-control-sm" value="{{ rec.bank_acc_name if rec else '' }}" required>
                </div>
                
                <div class="col-12">
                    <label for="m_nid" class="form-label small">National ID number <span class="text-danger">*</span></label>
                    <input 
                        type="text" 
                        id="m_nid" 
                        class="form-control form-control-sm text-start" 
                        pattern="\d{14}" 
                        maxlength="14" 
                        onkeypress="return (event.charCode >= 48 && event.charCode <= 57)"
                        title="ูุฌุจ ุฅุฏุฎุงู 14 ุฑูููุง ููุท" 
                        value="{{ rec.bank_national_id if rec else '' }}" 
                        placeholder="14 ุฑูููุง ููุท" 
                        required>
                </div>
                <div id="modal-error-message" class="col-12 text-danger small pt-2" style="display:none;"></div>

                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">ุฅูุบุงุก</button>
                    <button type="button" class="btn btn-info btn-sm fw-bold" id="btnBankSave"><i class="fas fa-save me-2"></i>ุญูุธ ูููู ุงูุจูุงูุงุช</button>
                </div>
            </div>
        </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ุงูุญุตูู ุนูู ุนูุงุตุฑ DOM
        const workTypeSelect = document.getElementById('work_type');
        const divTypeSelect = document.getElementById('div_type_select');
        const typeSelect = document.getElementById('type_select');
        const initialTypeInput = document.getElementById('initial_type_select');
        const workDetailContainer = document.getElementById('work_detail_container');
        const workDetailTextarea = document.getElementById('work_detail');
        const bankCodeLabel = document.getElementById('bakery_code_label'); // ูู ุงูููุฏุงู
        const displayBankCodeLabel = document.getElementById('display_bakery_code_label'); // ูู ุงููููุฐุฌ ุงูุฑุฆูุณู
        const bankModalEl = document.getElementById('bankModal');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const btnManualBankModal = document.getElementById('btn_manual_bank_modal');
        const btnSave = document.getElementById('btnSave');
        const bankDataWarning = document.getElementById('bank_data_warning');
        const hBankSaved = document.getElementById('h_bank_saved');
        const hForceSave = document.getElementById('h_force_save'); // ๐ฅ ุญูู ุฅุฌุจุงุฑ ุงูุญูุธ ุงูุฌุฏูุฏ
        const recordIdInput = document.getElementById('record_id'); // ุญูู ID ูู ุญุงูุฉ ุงูุชุนุฏูู

        // ุญููู ุงููููุฐุฌ ุงูููุฑูุกุฉ ููุท 
        const dispReq = document.getElementById('bank_request_number');
        const dispBak = document.getElementById('bank_bakery_code');
        const dispId = document.getElementById('bank_id');
        const dispAcc = document.getElementById('bank_acc_number');
        const dispName = document.getElementById('bank_acc_name');
        const dispNid = document.getElementById('bank_national_id');

        // ุฏุงูุฉ ูุชูุนูู/ุชุนุทูู ุฒุฑ ุงูุญูุธ ูุจููุฉ ุงููููุฐุฌ ูุฅุธูุงุฑ/ุฅุฎูุงุก ุชูุงุตูู ุงูุนูู
        function toggleFormState(isBankRequired, isBankDataSaved) {
            // ุฅุฐุง ูุงู ููุน ุงูุนูู "ุญุณุงุจุงุช ุจูููุฉ" ูุงูุจูุงูุงุช ูู ุชูุญูุธ ุจุนุฏ: ูุชู ุชุนุทูู ุฒุฑ ุงูุญูุธ ูุฅุธูุงุฑ ุงูุชุญุฐูุฑ
            const shouldDisable = isBankRequired && !isBankDataSaved;
            
            btnSave.disabled = shouldDisable;
            bankDataWarning.style.display = shouldDisable ? 'block' : 'none';

            // ุฅุธูุงุฑ/ุฅุฎูุงุก ุชูุงุตูู ุงูุนูู
            if (isBankRequired) {
                workDetailContainer.style.display = 'none';
                // ูุญุงูุธ ุนูู ุงููููุฉ ูู ูุถุน ุงูุชุนุฏูู ุฅุฐุง ูุงูุช ููุฌูุฏุฉุ ููู ูุถุน ุงูุฅูุดุงุก ูุถุน ูููุฉ ุงูุชุฑุงุถูุฉ
                if (workDetailTextarea.value.trim() === '' || workDetailTextarea.value.trim() === 'ุจูุงูุงุช ุจูููุฉ ููุนุจุฃุฉ') {
                    workDetailTextarea.value = 'ุจูุงูุงุช ุจูููุฉ ููุนุจุฃุฉ';
                }
            } else {
                workDetailContainer.style.display = 'block';
                // ุฅุฐุง ูุงูุช ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ ูุณุฌูุฉุ ูููู ุจูุณุญูุง ููุนูุฏ ุงููุณุชุฎุฏู ุฅุฏุฎุงู ุงูุชูุงุตูู ูู ุญุงูุฉ ุงูุนูู ุงูุนุงู
                if (workDetailTextarea.value.trim() === 'ุจูุงูุงุช ุจูููุฉ ููุนุจุฃุฉ') {
                    workDetailTextarea.value = '';
                }
            }
        }

        // ุฏุงูุฉ ููุชุญ ุงูููุฏุงู (ูุน ุฅุนุงุฏุฉ ุชุญููู ุงูููู ุงูููุฌูุฏุฉ)
        function openBankModal() {
            const modalInstance = new bootstrap.Modal(bankModalEl);
            
            // ุชุญููู ุงูููู ุงูููุฌูุฏุฉ ูู ุงูุญููู ุงููุฑุฆูุฉ (ุงูููุฑูุกุฉ ููุท) ุฅูู ุงูููุฏุงู ูุจู ูุชุญู
            document.getElementById('m_req').value  = dispReq.value;
            document.getElementById('m_bak').value  = dispBak.value;
            document.getElementById('m_id').value   = dispId.value;
            
            // BANK_ACC_NUMBER: ูุชู ุชุฎุฒูู ุงูุฑูู ููุท (ูุง ุจุนุฏ EG)
            const storedAccNum = dispAcc.value;
            document.getElementById('m_acc').value  = storedAccNum.toUpperCase().startsWith('EG') ? storedAccNum.substring(2) : '';
            
            document.getElementById('m_name').value = dispName.value;
            document.getElementById('m_nid').value  = dispNid.value;

            // ุฅุฒุงูุฉ ุฑุณุงูุฉ ุงูุฎุทุฃ ุงูุณุงุจูุฉ
            modalErrorMessage.style.display = 'none';
            
            // ุฅุฒุงูุฉ ูุฆุงุช is-invalid ุนูุฏ ุงููุชุญ
            const fields = [document.getElementById('m_req'), document.getElementById('m_bak'), document.getElementById('m_id'), document.getElementById('m_acc'), document.getElementById('m_name'), document.getElementById('m_nid')];
            fields.forEach(field => field.classList.remove('is-invalid'));

            // ๐ฅ ุงูุชุฃูุฏ ูู ุฃู ุญูู ุฅุฌุจุงุฑ ุงูุญูุธ ูู 0 ุนูุฏ ูุชุญ ุงููุงูุฐุฉ
            hForceSave.value = '0'; 

            modalInstance.show();
        }

        // ุชุญุฏูุซ ุฎูุงุฑุงุช ุงูููุน ุจูุงุกู ุนูู ุงููุทููุจ ุชูููุฐู (work_type)
        function updateTypeOptions(action) {
            typeSelect.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงูููุน --</option>';
            let options = [];

            if (action === 'ุฃุนูุงู ุฏุนู ุนุงูุฉ') {
                options = [
                    { value: 'ูุฎุจุฒ', text: 'ูุฎุจุฒ' },
                    { value: 'ุงุณุชุจุฏุงู', text: 'ุงุณุชุจุฏุงู' },
                    { value: 'ุชูููู', text: 'ุชูููู' }
                ];
            } else if (action === 'ุญุณุงุจุงุช ุจูููุฉ') {
                options = [
                    { value: 'ูุฎุจุฒ', text: 'ูุฎุจุฒ' },
                    { value: 'ุงุณุชุจุฏุงู', text: 'ุงุณุชุจุฏุงู' }
                ];
            }
            
            // ุชุญุฏูุฏ ุงููููุฉ ุงููุญููุธุฉ ุฅุฐุง ูุงูุช ููุฌูุฏุฉ
            const savedType = initialTypeInput ? initialTypeInput.value : '';

            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.text;
                if (savedType === opt.value) {
                    option.selected = true;
                }
                typeSelect.appendChild(option);
            });
            
            typeSelect.required = false;  
        }

        // ุชุญุฏูุซ ุชุณููุฉ ุญูู ุงูููุฏ ูู ุงูููุฏุงู ูุงููููุฐุฌ ุงูุฑุฆูุณู
        function updateModalCodeLabel(type) {
            let label = 'Bakery Code';
            if (type === 'ุงุณุชุจุฏุงู' || type === 'ุชูููู') {
                label = 'Grocer Code';
            }
            bankCodeLabel.innerHTML = `${label} <span class="text-danger">*</span>`; // ููููุฏุงู
            displayBankCodeLabel.textContent = label; // ูููููุฐุฌ ุงูุฑุฆูุณู
        }

        // **ุงููุณุชูุน ูููุน ุงูุนูู ุงููุญูู (Work Type)**
        workTypeSelect.addEventListener('change', () => {
            const selectedAction = workTypeSelect.value;
            const isBankRequired = selectedAction === 'ุญุณุงุจุงุช ุจูููุฉ';
            const isBankDataSaved = hBankSaved.value === '1';
            
            if (selectedAction === 'ุฃุนูุงู ุฏุนู ุนุงูุฉ' || isBankRequired) {
                divTypeSelect.style.display = 'block';
                updateTypeOptions(selectedAction);
                
                btnManualBankModal.style.display = isBankRequired ? 'grid' : 'none';
                
            } else {
                // ูู ุญุงูุฉ ุนุฏู ุงุฎุชูุงุฑ work_type
                divTypeSelect.style.display = 'none';
                typeSelect.value = '';
                btnManualBankModal.style.display = 'none';
            }
            
            // ุชุญุฏูุซ ุญุงูุฉ ุงููููุฐุฌ ุจูุงุกู ุนูู ูุง ุฅุฐุง ูุงูุช ุจูุงูุงุช ุงูุจูู ูุทููุจุฉ ููุณุฌูุฉ
            toggleFormState(isBankRequired, isBankDataSaved);
            updateModalCodeLabel(typeSelect.value);
        });
        
        // **ุงููุณุชูุน ููููุน (Type Select)**
        typeSelect.addEventListener('change', () => {
            const selectedType = typeSelect.value;
            const selectedAction = workTypeSelect.value;
            
            updateModalCodeLabel(selectedType);

            const isBankRequired = selectedAction === 'ุญุณุงุจุงุช ุจูููุฉ';
            const isBankDataSaved = hBankSaved.value === '1';

            // ุงูุชุนุฏูู: ุฅุฐุง ุชู ุงุฎุชูุงุฑ 'ุงูุญุณุงุจุงุช ุงูุจูููุฉ' ูุงุฎุชูุงุฑ ููุน ููุงูุช ุงูุจูุงูุงุช ุบูุฑ ูุญููุธุฉุ ุงูุชุญ ุงูููุฏุงู ุชููุงุฆููุง
            if (isBankRequired && !isBankDataSaved && selectedType !== '') {
                if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                    openBankModal(); 
                }
            }  
            
            toggleFormState(isBankRequired, isBankDataSaved);
        });


        // **ุงููุณุชูุน ูุฒุฑ ูุชุญ ูุงูุฐุฉ ุจูุงูุงุช ุงูุจูู**
        btnManualBankModal.addEventListener('click', openBankModal);


        // **ุงููุณุชูุน ูุฒุฑ ุญูุธ ุจูุงูุงุช ุงูุจูู ุฏุงุฎู ุงูููุฏุงู**
        // ๐ฅ ุชู ุชุนุฏูู ุงูุฏุงูุฉ ูุชุตุจุญ async ููุชุนุงูู ูุน AJAX
        document.getElementById('btnBankSave').addEventListener('click', async ()=>{
            // ุญููู ุงูููุฏุงู (ุงููุฏุฎูุงุช)
            const m_req = document.getElementById('m_req');
            const m_bak = document.getElementById('m_bak');
            const m_id = document.getElementById('m_id');
            const m_acc = document.getElementById('m_acc');
            const m_name = document.getElementById('m_name');
            const m_nid = document.getElementById('m_nid');
            
            // 1. ุงูุชุญูู ูู ุตูุงุญูุฉ ุงูุญููู ุงููุทููุจุฉ (Validation)
            const fields = [m_req, m_bak, m_id, m_acc, m_name, m_nid];
            let isValid = true;
            let errorMessage = '';

            // ๐ฅ ุฅุฒุงูุฉ ูุฆุงุช is-invalid ูุจู ุงูุชุญูู
            fields.forEach(field => field.classList.remove('is-invalid'));

            for (const field of fields) {
                if (!field.checkValidity()) {
                    isValid = false;
                    field.classList.add('is-invalid');
                    
                    if (field.id === 'm_nid' && field.value.length !== 14) {
                        errorMessage = 'ุงูุฑูู ุงููููู (National ID) ูุฌุจ ุฃู ูุชููู ูู 14 ุฑูููุง ุจุงูุถุจุท.';
                    } else if (field.id === 'm_id' && !field.value.toUpperCase().match(/^[A-Z]*$/)) {
                        errorMessage = 'ููุฏ ุงูุจูู (BANK_ID) ูุฌุจ ุฃู ูุญุชูู ุนูู ุญุฑูู ุฅูุฌููุฒูุฉ ูุจูุฑุฉ ููุท.';
                    } else if (field.value === '') {
                        errorMessage = 'ูุฑุฌู ุฅุฏุฎุงู ุฌููุน ุงูุญููู ุงููุทููุจุฉ.';
                    } else {
                        errorMessage = 'ูุฑุฌู ุงูุชุญูู ูู ุตุญุฉ ุงููุฏุฎูุงุช. ุชุฃูุฏ ูู ุฅุฏุฎุงู ุฃุฑูุงู ููุท ุญูุซูุง ูู ูุทููุจ ูุญุฑูู ูุจูุฑุฉ ูู BANK_ID.';
                    }
                    // ูููู ุฅุธูุงุฑ ุฃูู ุฎุทุฃ
                    break;
                }
            }
            
            if (!isValid) {
                modalErrorMessage.textContent = errorMessage;
                modalErrorMessage.style.display = 'block';
                return;
            }

            // ๐ฅ 2. ุงูุชุญูู ูู ุงูุชูุฑุงุฑ ุนุจุฑ AJAX (BANK_ACC_NUMBER ููุท)
            const bankAccNumber = 'EG' + m_acc.value.trim();
            let proceedWithSave = true;
            modalErrorMessage.style.display = 'none'; // ุฅุฎูุงุก ุงูุฑุณุงุฆู ุงูุณุงุจูุฉ
            hForceSave.value = '0'; // ุฅุนุงุฏุฉ ุชุนููู ุฅุฌุจุงุฑ ุงูุญูุธ

            if (workTypeSelect.value === 'ุญุณุงุจุงุช ุจูููุฉ') {
                try {
                    document.getElementById('btnBankSave').disabled = true;

                    const formData = new FormData();
                    formData.append('bank_acc_number', bankAccNumber);
                    
                    // ๐ฅ๐ฅ ุงูุชุนุฏูู ููุง: ุฅุฑุณุงู record_id ูู ุญุงูุฉ ุงูุชุนุฏูู ๐ฅ๐ฅ
                    if (recordIdInput) {
                        formData.append('record_id', recordIdInput.value);
                    }
                    
                    const response = await fetch("{{ url_for('support_bp.check_bank_data') }}", {
                        method: 'POST',
                        body: formData
                    });
                    
                    document.getElementById('btnBankSave').disabled = false;
                    
                    const result = await response.json();
                    
                    if (!result.ok && result.is_duplicate && result.field === 'bank_acc_number') {
                        // ุญุงูุฉ ุงูุชูุฑุงุฑ: ุฅุธูุงุฑ ุฑุณุงูุฉ ุงูุฎุทุฃ ูุทูุจ ุงูุชุฃููุฏ
                        modalErrorMessage.textContent = result.message;
                        modalErrorMessage.style.display = 'block';
                        m_acc.classList.add('is-invalid'); // ุชูููุฒ ุงูุญูู ุงูููุฑุฑ
                        
                        // ๐ฅ ุฑุณุงูุฉ ุงูุชุฃููุฏ ูุนุฏู ุชูุฑูุบ ุงูุดุงุดุฉ
                        const confirmMessage = result.message + "\n\nุงุถุบุท 'ููุงูู' ููุญูุธ ุฑุบู ุงูุชูุฑุงุฑุ ุฃู 'ุฅูุบุงุก' ููุชุนุฏูู.";
                        if (!confirm(confirmMessage)) {
                            // ุฅุฐุง ุฃูุบู ุงููุณุชุฎุฏูุ ูุง ูุชุงุจุน ููุจูู ูู ุงููุงูุฐุฉ ุงูููุจุซูุฉ
                            proceedWithSave = false;
                            hForceSave.value = '0'; 
                        } else {
                            // ุฅุฐุง ูุงูู ุงููุณุชุฎุฏูุ ูุถุจุท ุญูู ุฅุฌุจุงุฑ ุงูุญูุธ ููุณุชูุฑ
                            hForceSave.value = '1';
                        }
                    } else {
                        // ูุง ููุฌุฏ ุชูุฑุงุฑ (ุฃู ุงูุชูุฑุงุฑ ูู ููุณุฌู ุงูุญุงูู ููุณู ูุชู ุงุณุชุซูุงุคู)
                        hForceSave.value = '0';
                    }
                    
                } catch (error) {
                    document.getElementById('btnBankSave').disabled = false;
                    console.error('AJAX Error:', error);
                    // ูู ุญุงู ูุดู ุงูุงุชุตุงูุ ูุชู ุงูุฅูุณุงุญ ุนู ุงูุญูุธ ูุน ุชุญุฐูุฑ
                    modalErrorMessage.textContent = 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชุญูู ูู ุงูุชูุฑุงุฑ. ุณูุชู ุงูุฅูุณุงุญ ุนู ุงูุญูุธ.';
                    modalErrorMessage.style.display = 'block';
                    hForceSave.value = '1'; // ูุนุชุจุฑู ุฎุทุฃ ููุณูุญ ุจุงูุญูุธ ูุชุฌูุจ ุงูุฅุบูุงู
                }
            }


            // ๐ฅ 3. ุงููุชุงุจุนุฉ ุจุงูุญูุธ ุฅุฐุง ูู ููู ููุงู ุชูุฑุงุฑ ุฃู ุชู ุงูุชุฃููุฏ
            if (proceedWithSave) {
                // ููู ุงูููู ูู ุญููู ุงูููุฏุงู ุฅูู ุญููู ุงููููุฐุฌ ุงูุฑุฆูุณูุฉ (ุงูููุฑูุกุฉ ููุท)
                dispReq.value  = m_req.value.trim();
                dispBak.value  = m_bak.value.trim();
                dispId.value   = m_id.value.trim().toUpperCase();
                dispAcc.value  = bankAccNumber; // ุฏูุฌ EG 
                dispName.value = m_name.value.trim();
                dispNid.value  = m_nid.value.trim();

                // ุชุญุฏูุซ ุญุงูุฉ ุงูุญูุธ
                hBankSaved.value = '1';
                
                // ุฅูุบุงุก ุชุนุทูู ุงููููุฐุฌ ุงูุฑุฆูุณู (ูุฃู ุงูุจูุงูุงุช ุฃุตุจุญุช ูุณุฌูุฉ)
                toggleFormState(true, true);

                // ุฅุบูุงู ุงูููุฏุงู
                if (window.bootstrap){
                    bootstrap.Modal.getInstance(bankModalEl)?.hide();
                }
            }
        });
        
        // ูู ุจุชุดุบูู ุงูููุทู ุงูุฃููู ุนูุฏ ุชุญููู ุงูุตูุญุฉ
        window.onload = () => {
            // 1. ูู ุจุชุดุบูู ูุณุชูุน work_type ูุถุจุท ุญุงูุฉ ุงูุฃูุณุงู ููููุฃ ุฎูุงุฑุงุช ุงูููุน
            if (workTypeSelect.value) {
                workTypeSelect.dispatchEvent(new Event('change'));
            } else {
                // ุถูุงู ุชูุนูู ุฒุฑ ุงูุญูุธ ุฅุฐุง ูู ููู ููุงู ููุน ุนูู ูุญุฏุฏ ูุชุทูุจ ุจูุงูุงุช ุจูููุฉ
                toggleFormState(false, true); 
            }

            // 2. ุฅุฐุง ูุงูุช ููุงู ูููุฉ ูุญููุฉ ููููุนุ ูู ุจุชุดุบูู ูุณุชูุน ุงูููุน ูุชุญุฏูุซ ุงูุชุณููุงุช ูุญุงูุฉ ุฒุฑ ุงูุญูุธ
            if (typeSelect.value) {
                typeSelect.dispatchEvent(new Event('change'));
            }
        };
    });
</script>
{% endblock %}