{% extends "base.html" %}
{% block title %}الدعم الفني{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h5 mb-0">الدعم الفني</h1>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-dark" href="{{ request.referrer or url_for('main_bp.dashboard') }}">
      <i class="fas fa-arrow-right"></i> رجوع
    </a>
    <a class="btn btn-light" href="{{ url_for('main_bp.dashboard') }}">
      <i class="fas fa-home"></i> الصفحة الرئيسية
    </a>
    <a class="btn btn-success" href="{{ url_for('support_bp.export', q=q, search_in=search_in) }}">
      <i class="fas fa-file-export"></i> تصدير Excel
    </a>
    <a class="btn btn-primary" href="{{ url_for('support_bp.create') }}">
      <i class="fas fa-plus"></i> إضافة سجل
    </a>
  </div>
</div>

<!-- شريط البحث والخيارات -->
<form class="row gy-2 gx-2 align-items-end mb-3" method="get" action="{{ url_for('support_bp.index') }}">
  <div class="col-sm-6 col-lg-5">
    <label class="form-label">بحث</label>
    <input type="text" name="q" value="{{ q or '' }}" class="form-control" placeholder="اكتب نص البحث">
  </div>

  <div class="col-sm-6 col-lg-3">
    <label class="form-label">البحث في عمود</label>
    <select id="searchInSelect" name="search_in" class="form-select">
      <option value="all" {{ 'selected' if search_in=='all' }}>الكل (كل الأعمدة)</option>
      {% for c in (search_cols or []) %}
        <option value="{{ c }}" {{ 'selected' if search_in==c }}>{{ c }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-sm-6 col-lg-2">
    <label class="form-label">عدد السجلات</label>
    <select name="page_size" class="form-select">
      {% for n in [10,25,50,100,200,500] %}
        <option value="{{ n }}" {{ 'selected' if page_size==n }}>{{ n }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-sm-12 col-lg-2 text-end">
    <button class="btn btn-primary w-100" type="submit">
      <i class="fas fa-search"></i> تطبيق
    </button>
  </div>
</form>

{% if not cols or cols|length == 0 %}
  <div class="alert alert-info">لا توجد بيانات لعرضها.</div>
{% else %}
  <!-- الجدول (تم إضافة Scroll أفقي + رأسي لقراءة كل البيانات) -->
  <style>
    /* شريط تمرير أفقي + عدم لف النص داخل الجدول */
    .data-table-wrap { max-height: 65vh; overflow-y: auto; overflow-x: auto; }
    .data-table th, .data-table td { white-space: nowrap; }
  </style>
  <div class="table-responsive data-table-wrap">
    <table class="table table-sm table-striped table-hover table-bordered data-table align-middle text-center">
      <thead class="table-light">
        <tr>
          {% for c in cols %}
            <th class="border">{{ c }}</th>
          {% endfor %}
          <th class="border">إجراءات</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
          <tr>
            {% for c in cols %}
              <td class="border">{{ r.get(c,'') }}</td>
            {% endfor %}
            <td class="border text-nowrap">
              <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('support_bp.edit', rid=r['ID']) }}">
                <i class="fas fa-pen"></i> تعديل
              </a>
              <form class="d-inline" method="post" action="{{ url_for('support_bp.delete', rid=r['ID']) }}"
                    onsubmit="return confirm('حذف السجل؟');">
                <button class="btn btn-sm btn-outline-danger" type="submit">
                  <i class="fas fa-trash"></i> حذف
                </button>
              </form>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- ترقيم الصفحات: 1 و 2 و 3 … آخر صفحة -->
  <nav class="mt-3" aria-label="الصفحات">
    <ul class="pagination justify-content-center">
      <li class="page-item {% if not pagination.prev %}disabled{% endif %}">
        <a class="page-link" href="{{ pagination.prev or '#' }}">السابق</a>
      </li>

      {% for p in pagination.first_pages %}
        <li class="page-item {% if p.active %}active{% endif %}">
          <a class="page-link" href="{{ p.url }}">{{ p.n }}</a>
        </li>
      {% endfor %}

      {% if pagination.show_ellipsis %}
        <li class="page-item disabled"><span class="page-link">…</span></li>
      {% endif %}

      {% if pagination.last %}
        <li class="page-item {% if pagination.last.active %}active{% endif %}">
          <a class="page-link" href="{{ pagination.last.url }}">{{ pagination.last.n }}</a>
        </li>
      {% endif %}

      <li class="page-item {% if not pagination.next %}disabled{% endif %}">
        <a class="page-link" href="{{ pagination.next or '#' }}">التالي</a>
      </li>
    </ul>
    <p class="text-center text-muted small mb-0">
      صفحة {{ pagination.page }} من {{ pagination.total_pages }}
    </p>
  </nav>
{% endif %}
{% endblock %}

{% block scripts %}{% endblock %}
