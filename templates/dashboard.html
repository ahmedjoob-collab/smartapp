{% extends "base.html" %}
{% block title %}Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…{% endblock %}

{% block content %}
<!-- Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© ÙˆØ§Ù„ØªØ­ÙƒÙ… -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
  <div class="d-flex gap-2">
    <!-- Ø§Ù„Ø²Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± -->
    <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
      <i class="fas fa-key"></i> ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
    </button>
    
    <a class="btn btn-light" href="{{ url_for('main_bp.dashboard') }}">
      <i class="fas fa-home"></i> Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    </a>
  </div>
</div>

<!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø§Øª -->
<div class="row g-3">
  {% for s in sections %}
    <div class="col-12 col-sm-6 col-lg-4">
      {% if not s.disabled and s.url %}
        <a href="{{ s.url }}" class="text-decoration-none {% if s.title == 'Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…' %}inquiry-popup-link{% endif %}">
          <div class="card h-100 shadow-sm border-0">
            <div class="card-body d-flex align-items-center gap-3">
              <div class="badge bg-{{ s.badge }} p-3 rounded-circle">
                <i class="{{ s.icon }}"></i>
              </div>
              <div class="flex-grow-1">
                <div class="h5 mb-1">{{ s.title }}</div>
                <div class="text-muted small mb-0">{{ s.description }}</div>
              </div>
              <!-- ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù„Ù„Ù€ RTL -->
              <i class="fas fa-arrow-left text-muted" style="transform: scaleX(-1);"></i>
            </div>
          </div>
        </a>
      {% else %}
        <div class="card h-100 shadow-sm border-0 opacity-50"
              style="pointer-events:none; cursor:not-allowed;"
              aria-disabled="true"
              title="ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
          <div class="card-body d-flex align-items-center gap-3">
            <div class="badge bg-{{ s.badge }} p-3 rounded-circle">
              <i class="{{ s.icon }}"></i>
            </div>
            <div class="flex-grow-1">
              <div class="h5 mb-1">{{ s.title }}</div>
              <div class="text-muted small mb-0">{{ s.description }}</div>
            </div>
            <span class="ms-auto badge bg-secondary d-inline-flex align-items-center gap-1">
              <i class="fas fa-lock"></i> ØºÙŠØ± Ù…ØªØ§Ø­
            </span>
          </div>
        </div>
      {% endif %}
    </div>
  {% endfor %}
</div>

<!-- ============================================== -->
<!-- Ù†Ø§ÙØ°Ø© ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Change Password Modal) -->
<!-- ============================================== -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true" dir="rtl" data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered">
    <!--
      Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ù…Ø³Ø§Ø± 'users_bp.me_password' Ù…ÙØ¹Ø±Ù‘ÙÙ ÙÙŠ user_routes.py ÙˆÙŠØ³ØªÙ‡Ø¯Ù ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ (Self-service)
    -->
    <form class="modal-content" method="post" action="{{ url_for('users_bp.me_password') }}">
      <div class="modal-header">
        <h5 class="modal-title" id="changePasswordModalLabel">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Ø¥ØºÙ„Ø§Ù‚"></button>
      </div>
      <div class="modal-body">
        <!-- ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
        <div class="mb-3 text-start">
          <label for="new_password" class="form-label">ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©</label>
          <input name="new_password" id="new_password" type="password" minlength="6" class="form-control" required autocomplete="new-password" placeholder="Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ 6 Ø£Ø­Ø±Ù">
          <div class="form-text">ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© 6 Ø£Ø­Ø±Ù Ø£Ùˆ Ø£ÙƒØ«Ø±.</div>
        </div>

        <!-- ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
        <div class="mb-3 text-start">
          <label for="confirm_password" class="form-label">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
          <input name="confirm_password" id="confirm_password" type="password" minlength="6" class="form-control" required autocomplete="new-password" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
          <div class="form-text text-danger" id="password_match_error" style="display:none;">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©!</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-warning" type="submit" id="submit_password_change" disabled>
          <i class="fas fa-lock me-1"></i> ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        </button>
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // ğŸ’¡ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… (Pop-up Window Management)

    // Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ù…Ø±Ø¬Ø¹ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
    let inquiryWindow = null;
    const inquiryUrl = "{{ inquiry_url or '#' }}";

    document.addEventListener('DOMContentLoaded', () => {
        // 1. ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…
        const inquiryLink = document.querySelector('.inquiry-popup-link');
        if (inquiryLink) {
            // Ù†Ù…Ù†Ø¹ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ù…Ø³Ø§Ø± ÙˆÙ†Ø³ØªØ¨Ø¯Ù„Ù‡ Ø¨ÙØªØ­ Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø©
            inquiryLink.href = 'javascript:void(0)';

            inquiryLink.addEventListener('click', (e) => {
                e.preventDefault();
                // Ù„Ùˆ Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± Ù…ØªØ§Ø­ØŒ Ù„Ø§ ØªÙØªØ­ Ù†Ø§ÙØ°Ø©
                if (!inquiryUrl || inquiryUrl === '#') {
                    return;
                }
                
                // Ù„Ùˆ Ø§Ù„Ù†Ø§ÙØ°Ø© Ù…ÙØªÙˆØ­Ø© Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ù†Ø±ÙƒÙ‘Ø² Ø¹Ù„ÙŠÙ‡Ø§
                if (inquiryWindow && !inquiryWindow.closed) {
                    // ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø´Ø§Ø´Ø© Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù†Øª Ø§Ù„Ù†Ø§ÙØ°Ø© ØªØ¹Ø±Ø¶ ØµÙØ­Ø© Ù…Ø®ØªÙ„ÙØ©
                    try { inquiryWindow.location.href = inquiryUrl; } catch (err) {}
                    inquiryWindow.focus();
                } else {
                    // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©
                    const windowFeatures = "width=800,height=650,resizable=yes,scrollbars=yes";
                    // Ø§Ø³Ù… Ø§Ù„Ù†Ø§ÙØ°Ø© "InquiryPopup" ÙŠÙ…Ù†Ø¹ ÙØªØ­ Ù†ÙˆØ§ÙØ° Ù…ØªØ¹Ø¯Ø¯Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª
                    inquiryWindow = window.open(inquiryUrl, "InquiryPopup", windowFeatures);
                }
            });
        }
        
        // ----------------------------------------------------
        // ğŸ’¡ Ø¥Ø¯Ø§Ø±Ø© Ù†Ø§ÙØ°Ø© ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Modal Management)
        // ----------------------------------------------------

        const newPassInput = document.getElementById('new_password');
        const confirmPassInput = document.getElementById('confirm_password');
        const submitButton = document.getElementById('submit_password_change');
        const errorDiv = document.getElementById('password_match_error');
        const modal = document.getElementById('changePasswordModal');

        // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ ÙˆØ³Ù„Ø§Ù…Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        const validatePasswords = () => {
            const newPass = newPassInput.value;
            const confirmPass = confirmPassInput.value;
            
            const isMatch = newPass === confirmPass && newPass.length >= 6;

            if (newPass.length < 6) {
                errorDiv.textContent = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù„Ø§ ØªÙ‚Ù„ Ø¹Ù† 6 Ø£Ø­Ø±Ù.';
                errorDiv.style.display = 'block';
                submitButton.disabled = true;
            } else if (newPass !== confirmPass) {
                errorDiv.textContent = 'ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚.';
                errorDiv.style.display = 'block';
                submitButton.disabled = true;
            } else {
                errorDiv.style.display = 'none';
                submitButton.disabled = false;
            }
        };

        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
        if (newPassInput && confirmPassInput) {
            newPassInput.addEventListener('input', validatePasswords);
            confirmPassInput.addEventListener('input', validatePasswords);
        }

        // Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ØŒ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
        if (modal) {
            modal.addEventListener('hidden.bs.modal', () => {
                if (newPassInput) newPassInput.value = '';
                if (confirmPassInput) confirmPassInput.value = '';
                if (errorDiv) errorDiv.style.display = 'none';
                if (submitButton) submitButton.disabled = true;
            });
        }
    });

    // 2. Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø·)
    window.addEventListener('beforeunload', () => {
        if (inquiryWindow && !inquiryWindow.closed) {
            inquiryWindow.close();
        }
    });

    // 3. Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚Ù‡Ø§ ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØºÙŠØ±
    window.addEventListener('message', (event) => {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØµØ¯Ø± (Origin) Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø£Ù…Ù†ÙŠØ©
        if (event.origin !== window.location.origin) {
            return;
        }

        if (event.data === 'inquiry_popup_closed') {
            inquiryWindow = null;
        }
    });
</script>
{% endblock %}
